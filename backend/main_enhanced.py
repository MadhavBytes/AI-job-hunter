"""\nEnhanced FastAPI backend for AI Job Hunter\nIncludes job search, resume management, and auto-apply functionality\n"""\n\nfrom fastapi import FastAPI, HTTPException, UploadFile, File, BackgroundTasks\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom pydantic import BaseModel\nfrom typing import Optional, List, Dict, Any\nimport httpx\nimport logging\nimport json\nfrom datetime import datetime\nimport os\n\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\napp = FastAPI(title="AI Job Hunter - Enhanced API", version="1.0.0")\n\n# CORS middleware\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=["*"],\n    allow_credentials=True,\n    allow_methods=["*"],\n    allow_headers=["*"],\n)\n\n# Configuration\nFOORILLA_BASE_URL = "https://jobdataapi.com/api"\nFOORILLA_API_KEY = os.getenv("FOORILLA_API_KEY", "")\n\n# Pydantic Models\nclass JobSearchFilters(BaseModel):\n    title: Optional[str] = None\n    location: Optional[str] = None\n    country: Optional[str] = None\n    job_type: Optional[str] = None\n    min_salary: Optional[int] = None\n    experience_level: Optional[str] = None\n    remote: Optional[bool] = None\n    limit: int = 20\n    max_age_days: int = 30\n\nclass ResumeData(BaseModel):\n    name: str\n    email: str\n    phone: str\n    skills: List[str]\n    experience: str\n    education: str\n\nclass ApplicationRecord(BaseModel):\n    job_id: str\n    job_title: str\n    company: str\n    application_date: datetime\n    status: str = "applied"\n    notes: Optional[str] = None\n\n# In-memory storage (replace with database in production)\napplications_db: List[Dict[str, Any]] = []\nresumes_db: List[Dict[str, Any]] = []\n\n@app.get("/health")\nasync def health_check():\n    """Health check endpoint"""\n    return {\n        "status": "healthy",\n        "service": "AI Job Hunter Enhanced API",\n        "timestamp": datetime.now().isoformat()\n    }\n\n@app.post("/api/jobs/search")\nasync def search_jobs(filters: JobSearchFilters):\n    """\n    Search jobs from Foorilla API with comprehensive filters\n    """\n    try:\n        params = {\n            "limit": min(filters.limit, 100),\n            "max_age": filters.max_age_days\n        }\n\n        if filters.title:\n            params["title"] = filters.title\n        if filters.location:\n            params["location"] = filters.location\n        if filters.country:\n            params["country"] = filters.country\n        if filters.job_type:\n            params["job_type"] = filters.job_type\n        if filters.min_salary:\n            params["min_salary"] = filters.min_salary\n        if filters.experience_level:\n            params["experience_level"] = filters.experience_level\n        if filters.remote is not None:\n            params["remote"] = filters.remote\n\n        async with httpx.AsyncClient(timeout=30) as client:\n            response = await client.get(\n                f"{FOORILLA_BASE_URL}/jobs/",\n                params=params\n            )\n\n            if response.status_code == 200:\n                jobs = response.json().get('results', [])\n                return {\n                    "success": True,\n                    "total": len(jobs),\n                    "jobs": jobs,\n                    "filters_applied": filters.dict(exclude_none=True)\n                }\n            else:\n                raise HTTPException(status_code=response.status_code, detail="Failed to fetch jobs")\n\n    except Exception as e:\n        logger.error(f"Error searching jobs: {str(e)}")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@app.post("/api/resumes/upload")\nasync def upload_resume(file: UploadFile = File(...)):\n    """\n    Upload and parse resume\n    """\n    try:\n        content = await file.read()\n        resume_id = f"resume_{len(resumes_db) + 1}"\n        \n        resume_record = {\n            "id": resume_id,\n            "filename": file.filename,\n            "upload_date": datetime.now().isoformat(),\n            "size": len(content),\n            "file_type": file.content_type\n        }\n        \n        resumes_db.append(resume_record)\n        \n        return {\n            "success": True,\n            "message": f"Resume {file.filename} uploaded successfully",\n            "resume_id": resume_id,\n            "resume_data": resume_record\n        }\n\n    except Exception as e:\n        logger.error(f"Error uploading resume: {str(e)}")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@app.get("/api/resumes")\nasync def list_resumes():\n    """Get list of all uploaded resumes"""\n    return {\n        "success": True,\n        "total": len(resumes_db),\n        "resumes": resumes_db\n    }\n\n@app.post("/api/applications/auto-apply")\nasync def auto_apply_job(job_id: str, resume_id: str, background_tasks: BackgroundTasks):\n    """\n    Auto-apply to a job using specified resume\n    """\n    try:\n        app_id = f"app_{len(applications_db) + 1}"\n        \n        application = {\n            "id": app_id,\n            "job_id": job_id,\n            "resume_id": resume_id,\n            "application_date": datetime.now().isoformat(),\n            "status": "applied",\n            "created_at": datetime.now().isoformat()\n        }\n        \n        applications_db.append(application)\n        \n        # In background, you could trigger web automation here\n        background_tasks.add_task(simulate_application, job_id)\n        \n        return {\n            "success": True,\n            "message": f"Application submitted to job {job_id}",\n            "application_id": app_id,\n            "application": application\n        }\n\n    except Exception as e:\n        logger.error(f"Error applying to job: {str(e)}")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@app.get("/api/applications")\nasync def list_applications():\n    """Get all applications"""\n    return {\n        "success": True,\n        "total": len(applications_db),\n        "applications": applications_db\n    }\n\nasync def simulate_application(job_id: str):\n    """Simulate application submission (would use Playwright/Selenium in production)"""\n    logger.info(f"Processing auto-apply for job {job_id}")\n    # TODO: Implement web automation here\n    pass\n\nif __name__ == "__main__":\n    import uvicorn\n    port = int(os.getenv("PORT", 8000))\n    uvicorn.run(app, host="0.0.0.0", port=port)
